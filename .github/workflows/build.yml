name: Build Android APK

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    - name: Install NDK
      run: |
        yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --install "ndk;25.2.9519653"

    - name: Setup local.properties
      run: |
        echo "sdk.dir=$ANDROID_HOME" > local.properties
        echo "ndk.dir=$ANDROID_HOME/ndk/25.2.9519653" >> local.properties

    - name: Check CMake version
      run: cmake --version

    - name: Download and build raylib
      run: |
        git clone --depth 1 --branch 5.0 https://github.com/raysan5/raylib.git raylib-src

        # Only build arm64-v8a (32-bit has NEON compilation bugs in raylib 5.0)
        for ARCH in arm64-v8a; do
          echo "Building raylib for $ARCH..."
          mkdir -p raylib-src/build-android-$ARCH
          cd raylib-src/build-android-$ARCH

          cmake .. \
            -DCMAKE_TOOLCHAIN_FILE=$ANDROID_HOME/ndk/25.2.9519653/build/cmake/android.toolchain.cmake \
            -DANDROID_ABI=$ARCH \
            -DANDROID_PLATFORM=android-24 \
            -DANDROID_STL=c++_static \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_SHARED_LIBS=OFF \
            -DBUILD_EXAMPLES=OFF \
            -DPLATFORM=Android \
            -DGRAPHIC=GRAPHIC_API_OPENGL_ES_3 \
            -DUSE_WAYLAND=OFF \
            -DUSE_X11=OFF \
            -G "Unix Makefiles"

          make -j$(nproc)

          # Copy library and headers
          mkdir -p ../../app/src/main/cpp/jniLibs/$ARCH
          mkdir -p ../../app/src/main/cpp/include/raylib
          if [ -f raylib/libraylib.a ]; then
            cp raylib/libraylib.a ../../app/src/main/cpp/jniLibs/$ARCH/
          elif [ -f libraylib.a ]; then
            cp libraylib.a ../../app/src/main/cpp/jniLibs/$ARCH/
          else
            echo "ERROR: libraylib.a not found!"
            find . -name "libraylib.a"
            exit 1
          fi
          # Copy raylib headers
          cp -r ../src/*.h ../../app/src/main/cpp/include/raylib/
          cp -r ../src/external ../../app/src/main/cpp/include/raylib/

          cd ../..
        done

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v4
      with:
        gradle-version: 8.5

    - name: Build APK with Gradle
      run: |
        ./gradlew assembleDebug --no-daemon --no-build-cache --info --stacktrace 2>&1 | tee build-output.log

    - name: Upload APK
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: block-eater-apk
        path: app/build/outputs/apk/debug/app-debug.apk

    - name: Upload build log on failure
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: build-logs
        path: |
          build-output.log
          app/build/outputs/logs/
          app/.cxx/
          build/
