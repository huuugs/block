name: Build Android APK

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  BUILD_TYPE: Debug

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: read

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Decode keystore from secrets
      run: |
        echo "${{ secrets.DEBUG_KEYSTORE_BASE64 }}" | base64 -d > ~/.android/debug.keystore

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    - name: Install NDK
      run: |
        yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --install "ndk;25.2.9519653"

    - name: Setup local.properties
      run: |
        echo "sdk.dir=$ANDROID_HOME" > local.properties
        echo "ndk.dir=$ANDROID_HOME/ndk/25.2.9519653" >> local.properties

    - name: Check CMake version
      run: cmake --version

    - name: Download and build raylib
      run: |
        git clone --depth 1 --branch 5.0 https://github.com/raysan5/raylib.git raylib-src

        # Only build arm64-v8a (32-bit has NEON compilation bugs in raylib 5.0)
        for ARCH in arm64-v8a; do
          echo "Building raylib for $ARCH..."
          mkdir -p raylib-src/build-android-$ARCH
          cd raylib-src/build-android-$ARCH

          cmake .. \
            -DCMAKE_TOOLCHAIN_FILE=$ANDROID_HOME/ndk/25.2.9519653/build/cmake/android.toolchain.cmake \
            -DANDROID_ABI=$ARCH \
            -DANDROID_PLATFORM=android-24 \
            -DANDROID_STL=c++_shared \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_SHARED_LIBS=OFF \
            -DBUILD_EXAMPLES=OFF \
            -DPLATFORM=Android \
            -DGRAPHIC=GRAPHIC_API_OPENGL_ES_3 \
            -DUSE_WAYLAND=OFF \
            -DUSE_X11=OFF \
            -G "Unix Makefiles"

          make -j$(nproc)

          # Copy library and headers
          mkdir -p ../../app/src/main/cpp/jniLibs/$ARCH
          mkdir -p ../../app/src/main/cpp/include/raylib
          if [ -f raylib/libraylib.a ]; then
            cp raylib/libraylib.a ../../app/src/main/cpp/jniLibs/$ARCH/
          elif [ -f libraylib.a ]; then
            cp libraylib.a ../../app/src/main/cpp/jniLibs/$ARCH/
          else
            echo "ERROR: libraylib.a not found!"
            find . -name "libraylib.a"
            exit 1
          fi
          # Copy raylib headers
          cp -r ../src/*.h ../../app/src/main/cpp/include/raylib/
          cp -r ../src/external ../../app/src/main/cpp/include/raylib/

          cd ../..
        done

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v4
      with:
        gradle-version: 8.5

    - name: Build APK with Gradle
      run: |
        set -o pipefail
        ./gradlew assembleDebug --no-daemon --no-build-cache --info --stacktrace 2>&1 | tee build-output.log
        # Verify APK exists
        if [ ! -f "app/build/outputs/apk/debug/app-debug.apk" ]; then
          echo "ERROR: APK not found at expected location!"
          exit 1
        fi
      shell: bash

    - name: Get build info
      id: build_info
      run: |
        echo "timestamp=$(date -u +%Y%m%d_%H%M%S)" >> $GITHUB_OUTPUT
        echo "short_sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
        echo "commit_msg=$(git log -1 --pretty=%s)" >> $GITHUB_OUTPUT
        ls -lh app/build/outputs/apk/debug/app-debug.apk

    - name: Rename APK with version
      run: |
        cp app/build/outputs/apk/debug/app-debug.apk "block-eater-${{ steps.build_info.outputs.short_sha }}-${{ steps.build_info.outputs.timestamp }}.apk"
        echo "APK renamed to: block-eater-${{ steps.build_info.outputs.short_sha }}-${{ steps.build_info.outputs.timestamp }}.apk"

    # Upload APK as artifact (always available in Actions summary)
    - name: Upload APK Artifact
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: block-eater-apk-${{ steps.build_info.outputs.short_sha }}
        path: block-eater-*.apk
        retention-days: 30

    # Create Release for easy download
    - name: Create Release
      if: github.ref == 'refs/heads/main' && success()
      uses: softprops/action-gh-release@v1
      with:
        tag_name: build-${{ steps.build_info.outputs.timestamp }}-${{ steps.build_info.outputs.short_sha }}
        name: Block Eater Build ${{ steps.build_info.outputs.timestamp }}
        body: |
          ## Block Eater - Latest Build

          **Commit:** ${{ github.sha }}
          **Message:** ${{ steps.build_info.outputs.commit_msg }}
          **Build Time:** ${{ steps.build_info.outputs.timestamp }}

          ### ä¸‹è½½å®‰è£…åŒ…
          ç‚¹å‡»ä¸‹æ–¹ Assets ä¸­çš„ APK æ–‡ä»¶ä¸‹è½½å®‰è£…ã€‚

          ### å®‰è£…è¯´æ˜Ž
          1. ä¸‹è½½ APK æ–‡ä»¶
          2. åœ¨ Android è®¾å¤‡ä¸Šå…è®¸å®‰è£…æœªçŸ¥æ¥æºåº”ç”¨
          3. å®‰è£…å¹¶äº«å—æ¸¸æˆï¼

          ### åŠŸèƒ½ç‰¹æ€§
          - ä¸‰ç§æ¸¸æˆæ¨¡å¼ï¼šæ— å°½æ¨¡å¼ã€å…³å¡æ¨¡å¼ã€æ—¶é—´æŒ‘æˆ˜
          - è™šæ‹Ÿæ‘‡æ†å’Œè§¦æ‘¸è·Ÿéšä¸¤ç§æŽ§åˆ¶æ–¹å¼
          - å¤šç§ä¸»é¢˜åˆ‡æ¢
          - ä¸­æ–‡/è‹±æ–‡åŒè¯­æ”¯æŒ
        files: |
          block-eater-*.apk
        draft: false
        prerelease: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload build log on failure
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: build-logs-${{ steps.build_info.outputs.short_sha }}
        path: |
          build-output.log
          app/build/outputs/logs/
          app/.cxx/
          build/
        retention-days: 7

    # Add job summary for quick status view
    - name: Add Job Summary
      if: success()
      run: |
        echo "## âœ… Build Successful!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“± APK Download" >> $GITHUB_STEP_SUMMARY
        echo "- **Artifact:** block-eater-apk-${{ steps.build_info.outputs.short_sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Release:** [View Release](https://github.com/${{ github.repository }}/releases/tag/build-${{ steps.build_info.outputs.timestamp }}-${{ steps.build_info.outputs.short_sha }})" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“‹ Build Info" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit:** \`${{ steps.build_info.outputs.short_sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Time:** ${{ steps.build_info.outputs.timestamp }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Message:** ${{ steps.build_info.outputs.commit_msg }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸŽ® æ¸¸æˆç‰¹æ€§" >> $GITHUB_STEP_SUMMARY
        echo "- æ— å°½æ¨¡å¼ã€å…³å¡æ¨¡å¼ã€æ—¶é—´æŒ‘æˆ˜" >> $GITHUB_STEP_SUMMARY
        echo "- è™šæ‹Ÿæ‘‡æ† / è§¦æ‘¸è·ŸéšæŽ§åˆ¶" >> $GITHUB_STEP_SUMMARY
        echo "- å¤šç§ä¸»é¢˜åˆ‡æ¢" >> $GITHUB_STEP_SUMMARY
        echo "- ä¸­æ–‡/è‹±æ–‡åŒè¯­æ”¯æŒ" >> $GITHUB_STEP_SUMMARY
